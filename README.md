# WhatsApp AI Bot with Multi-Session Support

This project is a **microservice** developed in **NestJS** that integrates **whatsapp-web.js** with **OpenAI's GPT** to provide automatic responses to incoming WhatsApp messages.

Each WhatsApp session is linked to a unique identifier (`userUid`), allowing multi-tenant use (e.g., per branch or user), and includes independent message histories stored in **Redis**.

---

## ğŸš€ Technologies Used

- **NestJS**
- **whatsapp-web.js**
- **BullMQ** (for message queue management)
- **Redis** (for storing session data and conversation memory)
- **OpenAI** (for generating intelligent responses)
- **Docker** (optional, for local Redis deployment)

---

## ğŸ“¦ Folder Structure

```
whatsapp/
â”‚
â”œâ”€â”€ application/
â”‚   â”œâ”€â”€ jobs/                       # BullMQ Workers
â”‚   â””â”€â”€ services/                  # Core application logic
â”‚
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ models/                    # Interfaces and message types
â”‚   â”œâ”€â”€ ports/                     # Interfaces (Ports)
â”‚   â””â”€â”€ tokens/                    # Injection tokens
â”‚
â”œâ”€â”€ infrastructure/
â”‚   â”œâ”€â”€ adapters/                  # Redis, OpenAI, BullMQ adapters
â”‚   â”œâ”€â”€ clients/                   # WhatsApp session manager
â”‚   â””â”€â”€ repositories/             # Session persistence layer
â”‚
â”œâ”€â”€ presentation/
â”‚   â””â”€â”€ controllers/              # REST endpoints (e.g., init session)
â”‚
â”œâ”€â”€ utils/                        # Prompt formatting utilities
â”‚
â”œâ”€â”€ docker-compose.redis.yml     # Redis service (for local testing)
â””â”€â”€ main.ts                       # Bootstrap for Nest app
```

---

## ğŸ§  How It Works

1. A WhatsApp session is initialized via `GET /whatsapp/init-session?token=xxx`, generating a QR.
2. Once scanned, the client is marked as `ready`.
3. Incoming messages are received and queued (BullMQ).
4. The worker `ProcessIncomingMessageJob`:
   - Saves the user message to Redis memory
   - Retrieves recent conversation
   - Adds a system prompt and sends to OpenAI
   - Stores the assistantâ€™s response
   - Sends it back via WhatsApp

---

## ğŸ“‚ Environment Configuration

### .env

```env
REDIS_URL=redis://localhost:6379
WHATSAPP_MAX_CLIENTS=30
OPENAI_API_KEY=your_openai_key
OPENAI_MODEL=gpt-3.5-turbo
```

> ğŸ“ **Note:** Make sure your OpenAI API key has available credits or youâ€™ll receive a `RateLimitError 429` due to insufficient quota.

> ğŸ§© You can change the IA provider or caching system by modifying:
>
> - IA: `infrastructure/adapters/openai-client.adapter.ts`
> - Cache: `infrastructure/adapters/redis-cache.adapter.ts`

---

## ğŸ” Multi-Session by Token

Each `token` passed in the init-session is treated as a unique session ID (`userUid`). This allows:

- Multiple WhatsApp sessions in parallel
- Each one with its own QR, memory, and OpenAI interaction

---

## ğŸ³ Start Locally with Redis

1. Clone the repository:

```bash
git clone https://github.com/your-user/whatsapp-ai-assistant
cd whatsapp-ai-assistant
```

2. Launch Redis using Docker:

```bash
docker-compose -f docker-compose.redis.yml up -d
```

3. Start NestJS server:

```bash
yarn install
yarn start:dev
```

4. Open browser and initialize session:

```
GET http://localhost:3000/whatsapp/init-session?token=my-client-id
```

Scan QR code with your WhatsApp ğŸ‘€.

---

## ğŸ“¬ Optional Testing

To test Redis writing manually:

```ts
const testAdapter = app.get(RedisCacheAdapter);
await testAdapter.testWriteRead();
```

---

## ğŸ§ª Result

The bot will respond via WhatsApp using the latest context from Redis and logic generated by the AI.



