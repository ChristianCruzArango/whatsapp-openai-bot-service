# WhatsApp AI Bot with Multi-Session Support

This project is a **microservice** developed in **NestJS** that integrates **whatsapp-web.js** with **OpenAI's GPT** to provide automatic responses to incoming WhatsApp messages.

Each WhatsApp session is linked to a unique identifier (`userUid`), allowing multi-tenant use (e.g., per branch or user), and includes independent message histories stored in **Redis**.

---

## 🚀 Technologies Used

- **NestJS**
- **whatsapp-web.js**
- **BullMQ** (for message queue management)
- **Redis** (for storing session data and conversation memory)
- **OpenAI** (for generating intelligent responses)
- **Docker** (optional, for local Redis deployment)

---

## 📦 Folder Structure

```
whatsapp/
│
├── application/
│   ├── jobs/                       # BullMQ Workers
│   └── services/                  # Core application logic
│
├── domain/
│   ├── models/                    # Interfaces and message types
│   ├── ports/                     # Interfaces (Ports)
│   └── tokens/                    # Injection tokens
│
├── infrastructure/
│   ├── adapters/                  # Redis, OpenAI, BullMQ adapters
│   ├── clients/                   # WhatsApp session manager
│   └── repositories/             # Session persistence layer
│
├── presentation/
│   └── controllers/              # REST endpoints (e.g., init session)
│
├── utils/                        # Prompt formatting utilities
│
├── docker-compose.redis.yml     # Redis service (for local testing)
└── main.ts                       # Bootstrap for Nest app
```

---

## 🧠 How It Works

1. A WhatsApp session is initialized via `GET /whatsapp/init-session?token=xxx`, generating a QR.
2. Once scanned, the client is marked as `ready`.
3. Incoming messages are received and queued (BullMQ).
4. The worker `ProcessIncomingMessageJob`:
   - Saves the user message to Redis memory
   - Retrieves recent conversation
   - Adds a system prompt and sends to OpenAI
   - Stores the assistant’s response
   - Sends it back via WhatsApp

---

## 📂 Environment Configuration

### .env

```env
REDIS_URL=redis://localhost:6379
WHATSAPP_MAX_CLIENTS=30
OPENAI_API_KEY=your_openai_key
OPENAI_MODEL=gpt-3.5-turbo
```

> 📝 **Note:** Make sure your OpenAI API key has available credits or you’ll receive a `RateLimitError 429` due to insufficient quota.

> 🧩 You can change the IA provider or caching system by modifying:
>
> - IA: `infrastructure/adapters/openai-client.adapter.ts`
> - Cache: `infrastructure/adapters/redis-cache.adapter.ts`

---

## 🔁 Multi-Session by Token

Each `token` passed in the init-session is treated as a unique session ID (`userUid`). This allows:

- Multiple WhatsApp sessions in parallel
- Each one with its own QR, memory, and OpenAI interaction

---

## 🐳 Start Locally with Redis

1. Clone the repository:

```bash
git clone https://github.com/your-user/whatsapp-ai-assistant
cd whatsapp-ai-assistant
```

2. Launch Redis using Docker:

```bash
docker-compose -f docker-compose.redis.yml up -d
```

3. Start NestJS server:

```bash
yarn install
yarn start:dev
```

4. Open browser and initialize session:

```
GET http://localhost:3000/whatsapp/init-session?token=my-client-id
```

Scan QR code with your WhatsApp 👀.

---

## 📬 Optional Testing

To test Redis writing manually:

```ts
const testAdapter = app.get(RedisCacheAdapter);
await testAdapter.testWriteRead();
```

---

## 🧪 Result

The bot will respond via WhatsApp using the latest context from Redis and logic generated by the AI.



